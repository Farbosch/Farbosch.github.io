<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Torchlight Infinite – Farm Profit Calculator (+ AH Tax)</title>
  <style>
    :root{ --bg:#0b0f14;--panel:#121822;--panel-2:#0f141c;--accent:#ff8c32;--accent-2:#ffc16e;--text:#e7eef7;--muted:#9fb0c3;--danger:#ff5a63;--shadow:0 10px 30px rgba(0,0,0,.35);--radius:16px; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial;background:radial-gradient(1200px 700px at 80% -100px,#1b2230 0%,transparent 60%),var(--bg);color:var(--text);line-height:1.4}
    .container{max-width:1200px;margin:32px auto;padding:0 16px}
    header{display:flex;align-items:center;gap:16px;margin-bottom:20px}
    .logo{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:grid;place-items:center;box-shadow:var(--shadow)}
    .logo span{font-weight:900;color:#121212}
    h1{font-size:clamp(20px,4vw,30px);margin:0}
    .subtitle{color:var(--muted);font-size:14px}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid rgba(255,255,255,.05);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card h2{margin:0 0 8px;font-size:18px}
    .card .inner{padding:18px}
    .timer{display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap}
    .time{font-size:40px;font-weight:800;letter-spacing:1px}
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    button{appearance:none;border:none;background:#1a2331;color:var(--text);padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;transition:transform .05s ease,filter .2s ease;box-shadow:inset 0 0 0 1px rgba(255,255,255,.05)}
    button:hover{filter:brightness(1.15)}
    button:active{transform:translateY(1px)}
    .btn-accent{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#111;box-shadow:inset 0 0 0 1px rgba(0,0,0,.05)}
    .btn-danger{background:linear-gradient(135deg,#ff6e6e,var(--danger));color:#111}
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    thead th{font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);font-weight:800;text-align:left;padding:0 10px}
    tbody td{background:#0e141d;padding:12px 10px;vertical-align:middle}
    tbody tr td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
    tbody tr td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
    input[type="number"],input[type="text"]{width:100%;background:#0b111a;border:1px solid rgba(255,255,255,.06);color:var(--text);padding:10px 12px;border-radius:10px;font-size:14px}
    .row-actions{display:flex;gap:6px;justify-content:flex-end}
    .summary{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media(min-width:700px){.summary{grid-template-columns:repeat(5,minmax(0,1fr))}}
    .kpi{background:linear-gradient(180deg,#0c1119,#0a0f16);border:1px solid rgba(255,255,255,.06);padding:16px;border-radius:14px}
    .kpi small{color:var(--muted);display:block;margin-bottom:6px}
    .kpi .value{font-weight:900;font-size:20px}
    .disclaimer{color:var(--muted);font-size:12px;margin-top:8px}
    footer{margin-top:22px;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo"><span>∞</span></div>
      <div>
        <h1>Torchlight Infinite – Farm Profit Calculator</h1>
        <div class="subtitle">Timer • Costs • Items • AH Tax • Profit/hour</div>
      </div>
    </header>

    <section class="card">
      <div class="inner">
        <h2>Timer</h2>
        <div class="timer">
          <div class="time" id="timeDisplay">00:00:00</div>
          <div class="btns">
            <button class="btn-accent" id="startBtn">Start</button>
            <button class="btn-ghost" id="stopBtn">Stop</button>
            <button class="btn-danger" id="resetTimerBtn">Reset</button>
          </div>
        </div>
        <div style="height:12px"></div>
        <div class="summary">
          <div class="kpi"><small>Revenue (post-tax)</small><div class="value" id="kpiRevenue">—</div></div>
          <div class="kpi"><small>AH Tax (1/8)</small><div class="value" id="kpiTax">—</div></div>
          <div class="kpi"><small>Total Cost</small><div class="value" id="kpiCost">—</div></div>
          <div class="kpi"><small>Net Profit</small><div class="value" id="kpiNet">—</div></div>
          <div class="kpi"><small>Profit / Hour</small><div class="value" id="kpiPph">—</div></div>
        </div>
        <div class="disclaimer">Shortcuts: <b>Space</b> start/stop • <b>r</b> reset. Tax is always ON (1 FE per 8 FE revenue).</div>
      </div>
    </section>

    <section class="card" style="margin-top:16px">
      <div class="inner">
        <h2>Costs</h2>
        <table>
          <thead>
            <tr>
              <th style="width:28%">Item</th>
              <th style="width:18%">Qty</th>
              <th style="width:22%">Unit Price (FE)</th>
              <th style="width:22%">Line Total</th>
              <th style="width:10%"></th>
            </tr>
          </thead>
          <tbody id="costTbody"></tbody>
        </table>
        <div style="display:flex;gap:10px;margin-top:10px">
          <button class="btn-accent" id="addCostBtn">+ Add Cost</button>
          <button id="exportBtn">Export JSON</button>
          <button id="importBtn">Import JSON</button>
          <input type="file" id="fileInput" accept="application/json" style="display:none" />
          <button id="resetAllBtn">Clear All</button>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:16px">
      <div class="inner">
        <h2>Items (Revenue)</h2>
        <table>
          <thead>
            <tr>
              <th style="width:28%">Item</th>
              <th style="width:18%">Qty</th>
              <th style="width:22%">Unit Price (FE)</th>
              <th style="width:22%">Line Total</th>
              <th style="width:10%"></th>
            </tr>
          </thead>
          <tbody id="itemTbody"></tbody>
        </table>
        <div style="display:flex;gap:10px;margin-top:10px">
          <button class="btn-accent" id="addItemBtn">+ Add Item</button>
        </div>
      </div>
    </section>

    <footer>
      <div>Pro tip: start the timer when you begin farming, then add/update rows as you go. Profit/hour updates automatically.</div>
    </footer>
  </div>

  <datalist id="itemNames">
    <option value="A Terrible Price"></option>
    <option value="Abundance Compass Arcana Compass Trump"></option>
    <option value="Activation Medium"></option>
    <option value="Active Skill"></option>
    <option value="Aeterna Key"></option>
    <option value="Aeterna Key Fleeting Aeterna Key Eternal"></option>
    <option value="Amberon Core"></option>
    <option value="Ancient Blenders Tear"></option>
    <option value="Antinomy"></option>
    <option value="Antonius Help"></option>
    <option value="Antonius Research"></option>
    <option value="Aureole Rock"></option>
    <option value="Authority T2 Queens Grace Lust T3 Compass Sinful"></option>
    <option value="Base Mod"></option>
    <option value="Beacon Compass Ecliptic Compass Vast Ecliptic Compass Ascendant"></option>
    <option value="Beginning of the End"></option>
    <option value="Beginning of the Past"></option>
    <option value="Blacksail Compass Cube Compass Cube"></option>
    <option value="Blade Dancers Edges"></option>
    <option value="Brave I"></option>
    <option value="Brave V"></option>
    <option value="Card Arcana Compass The Fated Arcana Compass Sandlord"></option>
    <option value="Clergy Thinking"></option>
    <option value="Coldness"></option>
    <option value="Compass Boss Compass Beacon"></option>
    <option value="Compass Boss Compass Beacon Compass Progressing"></option>
    <option value="Compass Deep Space Probe Beacon"></option>
    <option value="Compass Familial Aeterna Compass Nightmare Compass Folklore"></option>
    <option value="Compass General Hunting Compass Mechanical Compass Brilliant"></option>
    <option value="Compass Progressing Beacon"></option>
    <option value="Compass Uncanny Folklore Compass Doll Compass Collection"></option>
    <option value="Compass Veteran Compass Unrivaled Veteran Compass Elite"></option>
    <option value="Corner of Divinity"></option>
    <option value="Corrupted Axis"></option>
    <option value="Crows Wail"></option>
    <option value="Dart Edict"></option>
    <option value="Deep Space Probe Beacon"></option>
    <option value="Deep Space Probe Compass"></option>
    <option value="Deep Space Probe Ember"></option>
    <option value="Deep Space Probe Fluorescent"></option>
    <option value="Deep Space Probe Gear"></option>
    <option value="Defile the Stars"></option>
    <option value="Desire Core Creation T2"></option>
    <option value="Desire Core Devastation T3"></option>
    <option value="Desire Core Record T1"></option>
    <option value="Disappearing Shadow"></option>
    <option value="Dive Edict"></option>
    <option value="Divine Supernova"></option>
    <option value="Divinity Emblem Hunting"></option>
    <option value="Divinity Emblem Machine"></option>
    <option value="Divinity Emblem Machine Divinity Emblem Might Divinity Emblem War Divinity Emblem Hunting"></option>
    <option value="Divinity Emblem Might"></option>
    <option value="Divinity Emblem War"></option>
    <option value="Divinity Fragment"></option>
    <option value="Divinity Pact Assorted"></option>
    <option value="Divinity Pact Fragment"></option>
    <option value="Divinity Stone"></option>
    <option value="Doll Artifact Compass Frozen Compass Frozen"></option>
    <option value="Echo of the Gods"></option>
    <option value="Ecliptic Compass Renown Edge Compass Militant Compass Priceless"></option>
    <option value="Edict Dart Edict Dive Edict Ruin Edict Doom"></option>
    <option value="Elite Compass Boss Compass Beacon"></option>
    <option value="Ember Compass Reserve Ember Compass Fluorescent Compass Colorful"></option>
    <option value="End of Divinity"></option>
    <option value="End of the Past"></option>
    <option value="Epic Wedge"></option>
    <option value="Eternal Edict"></option>
    <option value="Eternity"></option>
    <option value="Fallen Starlight"></option>
    <option value="Familiar Nexus"></option>
    <option value="Fire Gods Footsteps"></option>
    <option value="Fire Lords"></option>
    <option value="Flame Elementium"></option>
    <option value="Flame Sand"></option>
    <option value="Fleeting Aeterna Key"></option>
    <option value="Fluorescent Compass Focus Fluorescent Compass War Compass Valiant"></option>
    <option value="Gaze Upon Reflection"></option>
    <option value="Giant Civet Musk"></option>
    <option value="Glacial Abyss Beacon T7"></option>
    <option value="Glacial Abyss Beacon T8"></option>
    <option value="Gloomy Daffodil"></option>
    <option value="Glorious Axis"></option>
    <option value="God of Deception Slate"></option>
    <option value="God of Hunting Slate"></option>
    <option value="God of Knowledge Slate"></option>
    <option value="God of Machines Slate"></option>
    <option value="God of Might Slate"></option>
    <option value="God of War Slate"></option>
    <option value="Golden Iris"></option>
    <option value="Helio Rock"></option>
    <option value="Hundredfold Windfall"></option>
    <option value="Immolating Flame"></option>
    <option value="Inspiration Essence"></option>
    <option value="Kismet Dual"></option>
    <option value="Kismet Lone"></option>
    <option value="Lava Sea Beacon T7"></option>
    <option value="Lava Sea Beacon T8"></option>
    <option value="Legendary Wedge"></option>
    <option value="Legends Energy Core"></option>
    <option value="Lightning Strikers"></option>
    <option value="Lost Secrets"></option>
    <option value="Magic Memory Thread"></option>
    <option value="Magic Wedge"></option>
    <option value.="Magnificent Skill"></option>
    <option value="Matchless Ember"></option>
    <option value="Mauds Trick"></option>
    <option value="Mechanical Artifact Compass Cruising Mechanical Artifact Compass Dark"></option>
    <option value="Medium Fate"></option>
    <option value="Memory of Discipline"></option>
    <option value="Memory of Origin"></option>
    <option value="Memory of Progress"></option>
    <option value="Memory Thread"></option>
    <option value="Micro Fate"></option>
    <option value="Might Artifact Compass Mecha Might Artifact Compass Hunting"></option>
    <option value="Militant Compass Trinket Militant Compass Ember Compass Bounty"></option>
    <option value="Mist Essence"></option>
    <option value="Mod Sniper"></option>
    <option value="Mod Tank"></option>
    <option value="Mod Vanguard"></option>
    <option value="Mod Warlock"></option>
    <option value="New God Unifying Wedge"></option>
    <option value="Night Blooming Cereus"></option>
    <option value="Noble Skill"></option>
    <option value="Novel Compass Soldier Compass Strength"></option>
    <option value="Pages of Aeterna"></option>
    <option value="Passive Skill"></option>
    <option value="Pedigree of the Gods"></option>
    <option value="Plunder Compass Novel Compass Lavish Novel Compass Conquering"></option>
    <option value="Plunder Compass Sinful Plunder Artifact Compass Transgression"></option>
    <option value="Portent Moon"></option>
    <option value="Precious Ember"></option>
    <option value="Precise Skill"></option>
    <option value="Priceless Memory Scrap"></option>
    <option value="Probe Compass Deep"></option>
    <option value="Profound Probe Compass"></option>
    <option value="Profound Probe Divinity Stone"></option>
    <option value="Profound Probe Ember"></option>
    <option value="Profound Probe Flourishing"></option>
    <option value="Profound Probe Fluorescent"></option>
    <option value="Profound Probe Fluorescent Deep Space Probe Compass Profound"></option>
    <option value="Profound Probe Gear"></option>
    <option value="Pyric Stride"></option>
    <option value="Queens Grace Authority T2"></option>
    <option value="Queens Grace Lust T3"></option>
    <option value="Queens Grace Slaughter T1"></option>
    <option value="Queens Wick Imprisioned T1"></option>
    <option value="Queens Wick Pursuit T2"></option>
    <option value="Queens Wick Revenge T3"></option>
    <option value="Rare Memory Thread"></option>
    <option value="Rare Wedge"></option>
    <option value="Residents Eye"></option>
    <option value="Reversed Plumes"></option>
    <option value="Ruin Edict"></option>
    <option value="Sacred Fossil"></option>
    <option value="Sacrum Harbingers"></option>
    <option value="Sandalwood Incense"></option>
    <option value="Sandlord"></option>
    <option value="Second Divinity"></option>
    <option value."Secret of Glacial Abyss"></option>
    <option value="Shallow Dream Armor"></option>
    <option value="Shallow Dream Trinket"></option>
    <option value="Shallow Dream Weapon"></option>
    <option value="Snowpaper Fragment"></option>
    <option value="Soft Rush"></option>
    <option value="Solidified Tear"></option>
    <option value="Soul Candle T0"></option>
    <option value="Soul Candle T1"></option>
    <option value="Soul Candle T2"></option>
    <option value="Space Rift"></option>
    <option value="Sparks of Moth"></option>
    <option value="Sprout of Legends"></option>
    <option value="Star Net"></option>
    <option value="Starry Sky"></option>
    <option value="Starry Sky Deep Space Beacon"></option>
    <option value="Steel Forge Beacon T7"></option>
    <option value="Steel Forge Beacon T8"></option>
    <option value="Stray Fireflies"></option>
    <option value="Stygian Benzoin"></option>
    <option value="Supernova Explosion"></option>
    <option value="Support Skill"></option>
    <option value="Surge Compass Bandit Dark Surge Compass Divine"></option>
    <option value="The Beginning"></option>
    <option value="The End"></option>
    <option value="The Kiss of the Heartless"></option>
    <option value="Thunder Wastes Beacon T7"></option>
    <option value="Thunder Wastes Beacon T8"></option>
    <option value="Tomorrows Direction"></option>
    <option value="Tracers Tear"></option>
    <option value="Truth Flourishing"></option>
    <option value="Truth Fossil"></option>
    <option value="Twin Reflection"></option>
    <option value="Two Extremes Compass Desire Incarnation Cube Compass Aeterna"></option>
    <option value="Ultimate Ember"></option>
    <option value="Uncertain Voyage"></option>
    <option value="Undetermined Fate"></option>
    <option value="Unfettered Constellation"></option>
    <option value="Unhatched Shadow"></option>
    <option value="Void Sea Craving T1"></option>
    <option value="Void Sea Ecstacy T2"></option>
    <option value="Void Sea Sorrow T3"></option>
    <option value="Voidlands Beacon T7 Voidlands Beacon T8"></option>
    <option value="Walkers Boots"></option>
    <option value="Wandering Star"></option>
    <option value="War Compass Might Compass Flourishing"></option>
    <option value="Warrior Dark Surge Compass Blacksail Compass Returning"></option>
    <option value="When Sparks Set the Prairie Ablaze"></option>
    <option value="Winding Key"></option>
    <option value="Winter of Origin"></option>
  </datalist>

  <script>
  (function(){
    const fmt = new Intl.NumberFormat(undefined, { maximumFractionDigits: 2 });
    const money = (n)=> isFinite(n) ? fmt.format(n) : '—';

    const els = {
      timeDisplay: document.getElementById('timeDisplay'),
      startBtn: document.getElementById('startBtn'),
      stopBtn: document.getElementById('stopBtn'),
      resetTimerBtn: document.getElementById('resetTimerBtn'),
      kpiRevenue: document.getElementById('kpiRevenue'),
      kpiCost: document.getElementById('kpiCost'),
      kpiNet: document.getElementById('kpiNet'),
      kpiPph: document.getElementById('kpiPph'),
      kpiTax: document.getElementById('kpiTax'),
      addCostBtn: document.getElementById('addCostBtn'),
      costTbody: document.getElementById('costTbody'),
      addItemBtn: document.getElementById('addItemBtn'),
      itemTbody: document.getElementById('itemTbody'),
      exportBtn: document.getElementById('exportBtn'),
      importBtn: document.getElementById('importBtn'),
      fileInput: document.getElementById('fileInput'),
      resetAllBtn: document.getElementById('resetAllBtn'),
    };

    const STORAGE_KEY = 'tli-profit-data-v5';
    const defaultState = { timer: { running:false, start:0, elapsed:0 }, costs: [], items: [], settings: { taxEnabled: true } };
    function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)); }catch(e){ return null; } }
    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    let state = load() || defaultState;
    if (!state || typeof state !== 'object') state = JSON.parse(JSON.stringify(defaultState));
    if (!Array.isArray(state.items)) state.items = [];
    if (!Array.isArray(state.costs)) state.costs = [];
    if (!state.settings) state.settings = { taxEnabled: true }; else state.settings.taxEnabled = true;

    // MODIFIED: Ensure existing cost items are migrated to the new structure if they're not already.
    // This is a simple migration. More complex data might need more careful handling.
    state.costs.forEach(cost => {
        if (cost.amount !== undefined && cost.unit === undefined) {
            cost.unit = cost.amount;
            cost.qty = 1;
            delete cost.amount;
            delete cost.notes;
        }
    });
    save(); // Save the potentially migrated state

    let rafId = null;
    function msToHMS(ms){ const s = Math.floor(ms/1000); const hh = String(Math.floor(s/3600)).padStart(2,'0'); const mm = String(Math.floor((s%3600)/60)).padStart(2,'0'); const ss = String(s%60).padStart(2,'0'); return `${hh}:${mm}:${ss}`; }
    function getElapsedMs(){ const now = Date.now(); return state.timer.running ? state.timer.elapsed + (now - state.timer.start) : state.timer.elapsed; }
    function tick(){ const e = getElapsedMs(); els.timeDisplay.textContent = msToHMS(e); updateKPIs(e); if(state.timer.running){ rafId = requestAnimationFrame(tick); } }

    function start(){ if(state.timer.running) return; state.timer.running = true; state.timer.start = Date.now(); save(); cancelAnimationFrame(rafId); tick(); }
    function stop(){ if(!state.timer.running) return; const now = Date.now(); state.timer.elapsed += (now - state.timer.start); state.timer.running = false; state.timer.start = 0; save(); cancelAnimationFrame(rafId); tick(); }
    function resetTimer(){ state.timer = { running:false, start:0, elapsed:0 }; save(); cancelAnimationFrame(rafId); tick(); }

    els.startBtn.addEventListener('click', start);
    els.stopBtn.addEventListener('click', stop);
    els.resetTimerBtn.addEventListener('click', resetTimer);

    function newId(){ return Math.random().toString(36).slice(2,10); }

    function render(){
      // COSTS
      // MODIFIED: Changed render logic to match the new structure (same as Items)
      els.costTbody.innerHTML = '';
      state.costs.forEach(row=>{
        const lt = (Number(row.qty)||0) * (Number(row.unit)||0);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="text" list="itemNames" value="${row.name||''}" placeholder="Start typing…" data-field="name"></td>
          <td><input type="number" step="1" value="${row.qty??''}" placeholder="0" data-field="qty"></td>
          <td><input type="number" step="0.01" value="${row.unit??''}" placeholder="0" data-field="unit"></td>
          <td>${money(lt)}</td>
          <td class="row-actions">
            <button data-act="dup">Duplicate</button>
            <button class="btn-danger" data-act="del">Delete</button>
          </td>`;
        wireRow(tr, 'costs', row.id);
        els.costTbody.appendChild(tr);
      });

      // ITEMS
      els.itemTbody.innerHTML = '';
      state.items.forEach(row=>{
        const lt = (Number(row.qty)||0) * (Number(row.unit)||0);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="text" list="itemNames" value="${row.name||''}" placeholder="Start typing…" data-field="name"></td>
          <td><input type="number" step="1" value="${row.qty??''}" placeholder="0" data-field="qty"></td>
          <td><input type="number" step="0.01" value="${row.unit??''}" placeholder="0" data-field="unit"></td>
          <td>${money(lt)}</td>
          <td class="row-actions">
            <button data-act="dup">Duplicate</button>
            <button class="btn-danger" data-act="del">Delete</button>
          </td>`;
        wireRow(tr, 'items', row.id);
        els.itemTbody.appendChild(tr);
      });

      tick();
    }

    function wireRow(tr, listKey, id){
      const idx = state[listKey].findIndex(r=>r.id===id);
      tr.querySelectorAll('input').forEach(inp=>{
        inp.addEventListener('input', ()=>{
          const field = inp.dataset.field;
          let val = inp.value;
          if(inp.type==='number'){ val = inp.value === '' ? '' : Number(inp.value); }
          const row = state[listKey][idx];
          row[field] = val;
          save();
          
          // MODIFIED: Update line total for 'costs' as well as 'items'
          if(listKey==='items' || listKey==='costs'){
            const qty = Number(row.qty)||0; const unit = Number(row.unit)||0; const lt = qty * unit; const cells = tr.querySelectorAll('td'); if(cells[3]) cells[3].textContent = money(lt);
          }
          updateKPIs(getElapsedMs());
        });
      });
      const del = tr.querySelector('[data-act="del"]'); if(del) del.addEventListener('click', ()=>{ state[listKey].splice(idx,1); save(); render(); });
      const dup = tr.querySelector('[data-act="dup"]'); if(dup) dup.addEventListener('click', ()=>{ const copy = JSON.parse(JSON.stringify(state[listKey][idx])); copy.id = newId(); state[listKey].splice(idx+1, 0, copy); save(); render(); });
    }

    // MODIFIED: AddCostBtn now adds an object with 'qty' and 'unit'
    els.addCostBtn.addEventListener('click', ()=>{ state.costs.push({ id:newId(), name:'', qty:'', unit:'' }); save(); render(); });
    els.addItemBtn.addEventListener('click', ()=>{ state.items.push({ id:newId(), name:'', qty:'', unit:'' }); save(); render(); });

    function totals() {
        const revenueGross = state.items.reduce((s, r) => s + (Number(r.qty) || 0) * (Number(r.unit) || 0), 0);
        // MODIFIED: Cost calculation now uses 'qty' and 'unit'
        const cost = state.costs.reduce((s, r) => s + (Number(r.qty) || 0) * (Number(r.unit) || 0), 0);
        const tax = Math.floor(revenueGross / 8);
        const revenue = revenueGross - tax;
        const net = revenue - cost;
        return { revenueGross, tax, revenue, cost, net };
    }

    function updateKPIs(elapsedMs) {
        const { revenue, tax, cost, net } = totals();
        els.kpiRevenue.textContent = money(revenue);
        els.kpiTax.textContent = money(tax);
        els.kpiCost.textContent = money(cost);
        els.kpiNet.textContent = money(net);
        const hours = elapsedMs / (1000 * 60 * 60);
        const pph = hours > 0 ? net / hours : 0;
        els.kpiPph.textContent = money(pph);
    }

    // Add keyboard shortcuts
    document.addEventListener('keydown', (e)=>{
      if (document.activeElement && ['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) {
          return; // Don't trigger shortcuts if user is typing in a field
      }
      if (e.code === 'Space') {
          e.preventDefault();
          state.timer.running ? stop() : start();
      } else if (e.key === 'r' || e.key === 'R') {
          e.preventDefault();
          resetTimer();
      }
    });

    // Handle data import/export and reset
    els.exportBtn.addEventListener('click', () => {
        const dataStr = JSON.stringify(state, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `tli-farm-${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });

    els.importBtn.addEventListener('click', () => {
        els.fileInput.click();
    });

    els.fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                // Basic validation
                if (importedData && typeof importedData.timer === 'object' && Array.isArray(importedData.items) && Array.isArray(importedData.costs)) {
                    state = importedData;
                    // MODIFIED: Run the same migration on imported data
                    state.costs.forEach(cost => {
                        if (cost.amount !== undefined && cost.unit === undefined) {
                            cost.unit = cost.amount;
                            cost.qty = 1;
                            delete cost.amount;
                            delete cost.notes;
                        }
                    });
                    save();
                    render();
                } else {
                    alert('Invalid JSON file format.');
                }
            } catch (err) {
                alert('Error parsing JSON file.');
                console.error(err);
            } finally {
                els.fileInput.value = ''; // Reset file input
            }
        };
        reader.readAsText(file);
    });

    els.resetAllBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to clear all data, including the timer? This cannot be undone.')) {
            state = JSON.parse(JSON.stringify(defaultState));
            save();
            render();
        }
    });

    render(); // Initial render
  })();
  </script>
</body>
</html>
